<script type="module">
    // ... (imports e referências aos elementos continuam os mesmos)
    import { auth, db, loginGoogle } from "./firebase.js";
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ... (código de login do admin continua o mesmo)

    async function carregarUsuarios() {
      usuariosTable.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
      try {
        const querySnapshot = await getDocs(collection(db, "usuarios"));
        usuariosTable.innerHTML = "";
        if (querySnapshot.empty) {
            usuariosTable.innerHTML = "<tr><td colspan='4'>Nenhum usuário encontrado.</td></tr>";
            return;
        }
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const row = document.createElement("tr");
          const statusText = data.status === 'ativo' ? "✅ Ativo" : "❌ Inativo";
          
          // ATUALIZADO: Adicionamos os botões de plano novamente
          row.innerHTML = `
            <td>${data.email || "Não disponível"}</td>
            <td>${data.plano || "Pendente"}</td>
            <td>${statusText}</td>
            <td>
              <button class="plano-btn" onclick="setPlano('${docSnap.id}', 'Plano Básico')">Básico</button>
              <button class="plano-btn" onclick="setPlano('${docSnap.id}', 'Plano Premium')">Premium</button>
              <button class="plano-btn" onclick="setPlano('${docSnap.id}', 'Plano Black')">Black</button>
              <button class="desativar" onclick="setStatus('${docSnap.id}', 'inativo')">Desativar</button>
            </td>
          `;
          usuariosTable.appendChild(row);
        });
      } catch (error) {
        console.error("Erro ao carregar usuários:", error);
        usuariosTable.innerHTML = "<tr><td colspan='4'>Erro ao carregar usuários.</td></tr>";
      }
    }

    // Função para ativar/desativar
    window.setStatus = async (uid, novoStatus) => {
      try {
        // Se desativar, também limpa o plano
        const dataToUpdate = novoStatus === 'inativo' ? { status: novoStatus, plano: null } : { status: novoStatus };
        await updateDoc(doc(db, "usuarios", uid), dataToUpdate);
        carregarUsuarios();
      } catch (error) { console.error("Erro ao atualizar status:", error); }
    };

    // NOVA FUNÇÃO: Para definir o plano
    window.setPlano = async (uid, nomeDoPlano) => {
      try {
        // Ao definir um plano, também ativamos o usuário
        await updateDoc(doc(db, "usuarios", uid), {
          plano: nomeDoPlano,
          status: 'ativo'
        });
        carregarUsuarios();
      } catch (error) { console.error("Erro ao definir plano:", error); }
    };
  </script>