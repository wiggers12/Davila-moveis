<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nosso Cat√°logo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#3498db; --dark1:#2c3e50; --light1:#f9f9f9; }
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif;}
    body{background:var(--light1);color:#333;display:flex;flex-direction:column;min-height:100vh;}
    header{background:var(--dark1);color:#fff;padding:15px;text-align:center;font-weight:600;font-size:20px;position:sticky;top:0;z-index:1000;}
    main{flex:1;padding:10px;}

    /* Barra de pesquisa */
    .search-bar{display:flex;justify-content:center;margin:10px;}
    .search-bar input{width:100%;max-width:500px;padding:12px;border-radius:6px;border:1px solid #ccc;font-size:16px;}

    /* Categorias */
    .categorias{display:flex;gap:10px;overflow-x:auto;padding:10px;background:#fff;border-bottom:1px solid #ddd;}
    .categorias button{padding:8px 15px;border:none;border-radius:20px;background:#eee;cursor:pointer;font-weight:600;}
    .categorias button.active{background:#ffcc00;color:#000;}

    /* Produtos */
    .catalogo{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px;padding:15px;}
    .card{background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:10px;cursor:pointer;transition:.2s;position:relative;}
    .card:hover{transform:translateY(-3px);}
    .card img{width:100%;height:120px;object-fit:cover;border-radius:8px;}
    .card h3{font-size:15px;margin:8px 0 5px;}
    .card p{color:#27ae60;font-weight:600;margin:2px 0;}

    /* Modal produto */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:1000;}
    .modal-content{background:#fff;border-radius:10px;padding:20px;max-width:600px;width:95%;max-height:90%;overflow-y:auto;}
    .modal-content img{width:100%;border-radius:8px;margin-bottom:10px;}
    .thumbs{display:flex;gap:10px;margin-top:10px;}
    .thumbs img{width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid transparent;}
    .thumbs img.active{border:2px solid #ffcc00;}
    .btn{display:inline-block;margin:10px 5px 0;padding:10px 15px;border:none;border-radius:6px;font-weight:600;cursor:pointer;text-align:center;}
    .btn-whats{background:#25d366;color:#fff;}
    .btn-site{background:#3498db;color:#fff;}
    .btn-cart{background:#ff9800;color:#fff;}

    /* Carrinho */
    #cart-btn{position:fixed;bottom:80px;right:20px;background:#ff9800;color:#fff;border:none;border-radius:50%;width:60px;height:60px;font-size:22px;cursor:pointer;z-index:1100;}
    #cart-count{position:absolute;top:-5px;right:-5px;background:red;color:#fff;border-radius:50%;font-size:14px;width:22px;height:22px;display:flex;align-items:center;justify-content:center;}
    #cart-modal .modal-content{max-width:400px;}
    .cart-item{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .cart-item img{width:50px;height:50px;border-radius:6px;object-fit:cover;}
    .cart-total{font-weight:700;margin-top:15px;}

    /* Checkout */
    .checkout{margin-top:20px;}
    .checkout label{display:block;margin:10px 0 5px;font-weight:600;}
    .checkout select,.checkout input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;}

    /* Toast */
    #toast{position:fixed;bottom:20px;right:20px;z-index:2000;}
    .toast{background:#333;color:#fff;padding:12px 18px;border-radius:6px;margin-top:8px;animation:slideIn .3s,fadeOut .3s 4s forwards;}
    @keyframes slideIn{from{opacity:0;transform:translateX(100%);}to{opacity:1;transform:translateX(0);}}
    @keyframes fadeOut{to{opacity:0;transform:translateX(100%);}}

    /* Rodap√© */
    footer{background:#2c3e50;color:#fff;padding:20px;text-align:center;margin-top:auto;}
    footer a{color:#ffcc00;text-decoration:none;margin:0 5px;}
  </style>
</head>
<body>

<header>üõçÔ∏è Cat√°logo de Produtos</header>

<!-- Barra de pesquisa -->
<div class="search-bar">
  <input type="text" id="search" placeholder="üîé Buscar produtos..." oninput="filtrarProdutos()">
</div>

<!-- Categorias -->
<div class="categorias" id="categorias"></div>

<main>
  <div class="catalogo" id="catalogo"></div>
</main>

<!-- Modal produto -->
<div class="modal" id="productModal">
  <div class="modal-content">
    <h2 id="prodTitle"></h2>
    <img id="mainImg" src="">
    <div class="thumbs" id="thumbs"></div>
    <p id="prodDesc"></p>
    <p id="prodPrice" style="color:#27ae60;font-weight:700;font-size:18px;"></p>
    <button class="btn btn-whats" id="buyWhats">Comprar no WhatsApp</button>
    <button class="btn btn-site" id="buySite">Comprar no Site</button>
    <button class="btn btn-cart" id="addCart">Adicionar ao Carrinho</button>
    <button class="btn" onclick="closeModal()">Fechar</button>
  </div>
</div>

<!-- Modal carrinho -->
<div class="modal" id="cart-modal">
  <div class="modal-content">
    <h2>üõí Seu Carrinho</h2>
    <div id="cart-items"></div>
    <p class="cart-total">Total: R$ <span id="cart-total">0.00</span></p>

    <div class="checkout">
      <label for="pay">Forma de Pagamento</label>
      <select id="pay">
        <option value="pix">Pix</option>
        <option value="card">Cart√£o de Cr√©dito</option>
        <option value="boleto">Boleto</option>
      </select>
      <div id="extra"></div>
      <button class="btn btn-whats" onclick="checkoutWhats()">Finalizar no WhatsApp</button>
      <button class="btn btn-site" onclick="checkoutCatalog()">Pagar Agora</button>
    </div>

    <button class="btn" onclick="closeCart()">Fechar</button>
  </div>
</div>

<!-- Bot√£o carrinho -->
<button id="cart-btn">üõí <span id="cart-count">0</span></button>

<!-- Toast -->
<div id="toast"></div>

<!-- Rodap√© -->
<footer>
  <p>¬© 2025 Meu Cat√°logo. Todos os direitos reservados.</p>
  <p><a href="https://wa.me/5551998378751" target="_blank">WhatsApp</a> | <a href="#">Instagram</a> | <a href="#">Facebook</a></p>
</footer>

<script>
  const ownerId='{{ owner_id }}';
  let allProducts=[],cart=JSON.parse(localStorage.getItem("cart")||"[]"),selectedProduct=null,categoriaSelecionada="Todos";

  document.addEventListener("DOMContentLoaded",initializeCatalog);

  async function initializeCatalog(){
    try{
      // üîî Notifica o admin que algu√©m entrou
      await fetch('/api/notify_visit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ownerId})});

      // Busca os produtos
      const res=await fetch(`/api/catalog_data/${ownerId}`);
      const data=await res.json();
      allProducts=data.products||[];
      renderCategorias(); renderCatalogo(allProducts); updateCart();
    }catch(e){console.error("Erro cat√°logo:",e);}
  }

  function renderCategorias(){
    const cats=["Todos",...new Set(allProducts.map(p=>p.categoria||"Outros"))];
    document.getElementById("categorias").innerHTML=cats.map(c=>`<button class="${c===categoriaSelecionada?"active":""}" onclick="filtrarCategoria('${c}')">${c}</button>`).join("");
  }
  function filtrarCategoria(cat){categoriaSelecionada=cat;renderCategorias();renderCatalogo();}
  function filtrarProdutos(){
    const termo=document.getElementById("search").value.toLowerCase();
    const filtrados=allProducts.filter(p=>(p.nome?.toLowerCase().includes(termo)||p.descricao?.toLowerCase().includes(termo)));
    renderCatalogo(filtrados);
  }

  function renderCatalogo(lista=allProducts){
    const grid=document.getElementById("catalogo"); grid.innerHTML="";
    lista.filter(p=>(categoriaSelecionada==="Todos"||p.categoria===categoriaSelecionada)).forEach(p=>{
      const card=document.createElement("div"); card.className="card";
      card.innerHTML=`<img src="${p.imagemUrl||'https://via.placeholder.com/300x200'}"><h3>${p.nome}</h3><p>R$ ${(p.valor||0).toFixed(2)}</p>`;
      card.onclick=()=>openProduct(p.id);
      grid.appendChild(card);
    });
  }

  async function openProduct(id){
    const res=await fetch(`/api/products/${id}`);
    const p=await res.json(); selectedProduct=p;
    const thumbsHtml=(p.imagens||[p.imagemUrl]).map((img,i)=>`<img src="${img}" class="${i===0?'active':''}" onclick="document.getElementById('mainImg').src='${img}'">`).join("");
    document.getElementById("prodTitle").innerText=p.nome;
    document.getElementById("mainImg").src=p.imagemUrl||'https://via.placeholder.com/400x300';
    document.getElementById("thumbs").innerHTML=thumbsHtml;
    document.getElementById("prodDesc").innerText=p.descricao||'';
    document.getElementById("prodPrice").innerText="R$ "+(p.valor||0).toFixed(2);
    document.getElementById("buyWhats").onclick=()=>window.open(`https://wa.me/5551998378751?text=Quero comprar ${p.nome} por R$${(p.valor||0).toFixed(2)}`);
    document.getElementById("buySite").onclick=()=>alert("Checkout em breve!");
    document.getElementById("addCart").onclick=()=>addToCart(p);
    document.getElementById("productModal").style.display="flex";
  }
  function closeModal(){document.getElementById("productModal").style.display="none";}

  function addToCart(p){cart.push(p);updateCart();closeModal();showToast(`${p.nome} adicionado ao carrinho!`);}
  function updateCart(){
    const el=document.getElementById("cart-items");el.innerHTML="";let total=0;
    cart.forEach((i,idx)=>{total+=i.valor||0;el.innerHTML+=`<div class="cart-item"><img src="${i.imagemUrl||'https://via.placeholder.com/50'}"><span>${i.nome}</span><span>R$ ${(i.valor||0).toFixed(2)}</span><button onclick="removeFromCart(${idx})">‚ùå</button></div>`;});
    document.getElementById("cart-total").innerText=total.toFixed(2);
    document.getElementById("cart-count").innerText=cart.length;
    localStorage.setItem("cart",JSON.stringify(cart));
  }
  function removeFromCart(i){cart.splice(i,1);updateCart();}
  document.getElementById("cart-btn").onclick=()=>document.getElementById("cart-modal").style.display="flex";
  function closeCart(){document.getElementById("cart-modal").style.display="none";}

  function checkoutWhats(){
    let msg="Ol√°, quero finalizar minha compra:\n";cart.forEach(i=>msg+=`- ${i.nome} R$${(i.valor||0).toFixed(2)}\n`);
    msg+=`Total: R$ ${cart.reduce((a,b)=>a+(b.valor||0),0).toFixed(2)}`;
    window.open("https://wa.me/5551998378751?text="+encodeURIComponent(msg));
  }
  function checkoutCatalog(){
    const metodo=document.getElementById("pay").value,extra=document.getElementById("extra");
    if(metodo==="pix"){extra.innerHTML="<p>‚ö° Pix: chave <b>pix@empresa.com</b></p>";}
    else if(metodo==="card"){extra.innerHTML="<input placeholder='N√∫mero do Cart√£o'>";}
    else{extra.innerHTML="<p>üìÑ Boleto gerado!</p>";}
  }

  function showToast(msg){const t=document.createElement("div");t.className="toast";t.innerText=msg;document.getElementById("toast").appendChild(t);setTimeout(()=>t.remove(),4300);}
</script>
</body>
</html>