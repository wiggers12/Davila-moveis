<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nosso Cat√°logo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #3498db; --dark1: #2c3e50; --light1: #ecf0f1; }

    body { font-family: 'Poppins', sans-serif; background-color: var(--light1); margin: 0; }

    /* Cabe√ßalho */
    header { background: var(--dark1); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 1000; }
    header h1 { margin: 0; font-weight: 600; font-size: 22px; }

    /* Barra de pesquisa */
    .search-bar { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin: 15px 0; box-sizing: border-box; }

    /* Grid de produtos */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.2s; cursor: pointer; }
    .product-card:hover { transform: translateY(-4px); }
    .product-card img { width: 100%; height: 160px; object-fit: cover; }
    .product-info { padding: 15px; text-align: center; }
    .product-info h3 { margin: 0 0 8px; font-size: 15px; color: var(--dark1); }
    .product-info p { font-size: 18px; font-weight: 600; color: var(--primary); margin: 0; }

    /* Modal de produto */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
    .modal.active { opacity: 1; visibility: visible; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-content img { width: 100%; border-radius: 8px; object-fit: cover; }
    .modal-content h2 { margin: 15px 0 10px; color: var(--dark1); }
    .modal-price { font-size: 20px; font-weight: bold; color: var(--primary); margin: 10px 0; }
    .modal-description { margin-bottom: 15px; line-height: 1.5; color: #555; }
    .modal-video { width: 100%; aspect-ratio: 16 / 9; border: none; border-radius: 8px; background-color: #000; margin-top: 15px; }
    .close-btn { background: var(--dark1); color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px; }

    /* Bot√£o carrinho */
    #cart-btn { position: fixed; bottom: 20px; right: 20px; background: orange; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 22px; cursor: pointer; z-index: 1200; }
    #cart-count { position: absolute; top: -5px; right: -5px; background: red; color: #fff; font-size: 14px; border-radius: 50%; padding: 2px 6px; }

    /* Bot√£o chat */
    #chat-btn { position: fixed; bottom: 90px; right: 20px; background: #3498db; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 22px; cursor: pointer; z-index: 1200; }

    /* Modal chat */
    #chat-modal { display: none; position: fixed; bottom: 160px; right: 20px; width: 300px; max-height: 400px; background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; z-index: 1300; }
    #chat-box { display: flex; flex-direction: column; height: 100%; }
    #chat-messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; }
    #chat-input-area { display: flex; border-top: 1px solid #ddd; }
    #chat-input { flex: 1; border: none; padding: 10px; font-size: 14px; }
    #send-btn { background: var(--primary); color: #fff; border: none; padding: 10px; cursor: pointer; }

    /* Rodap√© */
    footer { background: var(--dark1); color: white; text-align: center; padding: 15px; margin-top: 30px; }
    footer a { color: var(--primary); margin: 0 8px; text-decoration: none; }
  </style>
</head>
<body>

<header><h1>üõçÔ∏è Nosso Cat√°logo</h1></header>

<main class="container">
  <input type="text" id="search-input" class="search-bar" placeholder="üîé Buscar produtos...">
  <div id="product-grid" class="product-grid"><p>Carregando produtos...</p></div>
</main>

<!-- Bot√µes -->
<button id="chat-btn">üí¨</button>
<button id="cart-btn">üõí <span id="cart-count">0</span></button>

<!-- Modal de chat -->
<div id="chat-modal">
  <div id="chat-box">
    <div id="chat-messages"></div>
    <div id="chat-input-area">
      <input id="chat-input" placeholder="Digite sua mensagem...">
      <button id="send-btn">Enviar</button>
    </div>
  </div>
</div>

<footer>
  <p>¬© 2025 Nosso Cat√°logo. Todos os direitos reservados.</p>
  <p><a href="#">WhatsApp</a> | <a href="#">Instagram</a> | <a href="#">Facebook</a></p>
</footer>

<script>
  const ownerId = '{{ owner_id }}';
  let allProducts = [];

  document.addEventListener('DOMContentLoaded', initializeCatalog);

  async function initializeCatalog() {
    try {
      // Notifica o servidor da visita
      await fetch('/api/notify_visit', { 
        method: 'POST', 
        body: JSON.stringify({ ownerId: ownerId }), 
        headers: {'Content-Type': 'application/json'} 
      });

      // Carrega produtos
      const response = await fetch(`/api/catalog_data/${ownerId}`);
      if (!response.ok) throw new Error('Falha ao buscar produtos.');
      const data = await response.json();
      allProducts = data.products;
      renderCatalog(allProducts);
    } catch (error) {
      console.error("Erro no cat√°logo:", error);
      document.getElementById('product-grid').innerHTML = "<p style='color:red;'>N√£o foi poss√≠vel carregar este cat√°logo.</p>";
    }
  }

  function renderCatalog(productsToRender) {
    const grid = document.getElementById('product-grid');
    if (!productsToRender || productsToRender.length === 0) {
      grid.innerHTML = "<p>Nenhum produto encontrado neste cat√°logo.</p>";
      return;
    }
    grid.innerHTML = productsToRender.map(p => `
      <div class="product-card" onclick="showProductDetail('${p.id}')">
        <img src="${p.imagemUrl || 'https://via.placeholder.com/400x300'}" alt="${p.nome}">
        <div class="product-info">
          <h3>${p.nome}</h3><p>R$ ${(p.valor || 0).toFixed(2)}</p>
        </div>
      </div>`).join('');
  }

  async function showProductDetail(productId) {
    try {
      const response = await fetch(`/api/products/${productId}`);
      if (!response.ok) throw new Error('Produto n√£o encontrado.');
      const product = await response.json();
      let videoContent = '';
      if (product.videoUrl) {
        if (product.videoUrl.includes('firebasestorage.googleapis.com')) {
          videoContent = `<video class="modal-video" controls src="${product.videoUrl}"></video>`;
        } else if (product.videoUrl.includes('youtube.com') || product.videoUrl.includes('youtu.be')) {
          const youtubeEmbedUrl = convertToEmbedUrl(product.videoUrl);
          videoContent = `<iframe class="modal-video" src="${youtubeEmbedUrl}" frameborder="0" allowfullscreen></iframe>`;
        }
      }
      const modalHtml = `
      <div class="modal active" id="detail-modal" onclick="closeModal('detail-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
          <img src="${product.imagemUrl || 'https://via.placeholder.com/600x400'}" alt="${product.nome}">
          <h2>${product.nome}</h2>
          <p class="modal-price">R$ ${(product.valor || 0).toFixed(2)}</p>
          <p class="modal-description">${product.descricao || 'Nenhuma descri√ß√£o dispon√≠vel.'}</p>
          ${videoContent}
          <button class="close-btn" onclick="closeModal('detail-modal')">Fechar</button>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    } catch (error) {
      alert("N√£o foi poss√≠vel carregar os detalhes deste produto.");
    }
  }

  function convertToEmbedUrl(url) {
    if (!url) return '';
    let videoId = '';
    try {
      if (url.includes("youtu.be/")) videoId = new URL(url).pathname.substring(1);
      else if (url.includes("watch?v=")) videoId = new URL(url).searchParams.get("v");
    } catch (e) { return ''; }
    return videoId ? `https://www.youtube.com/embed/${videoId}` : '';
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('active');
      modal.addEventListener('transitionend', () => modal.remove(), { once: true });
    }
  }

  // Filtro de pesquisa
  document.getElementById('search-input').addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredProducts = allProducts.filter(p => 
      (p.nome && p.nome.toLowerCase().includes(searchTerm)) || 
      (p.descricao && p.descricao.toLowerCase().includes(searchTerm))
    );
    renderCatalog(filteredProducts);
  });

  // Chat
  const chatBtn = document.getElementById("chat-btn");
  const chatModal = document.getElementById("chat-modal");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  chatBtn.onclick = () => {
    chatModal.style.display = chatModal.style.display === "flex" ? "none" : "flex";
    chatModal.style.flexDirection = "column";
  };

  sendBtn.onclick = () => {
    if(chatInput.value.trim()!==""){
      const msg = document.createElement("div");
      msg.textContent = "üë§ Voc√™: " + chatInput.value;
      chatMessages.appendChild(msg);
      chatInput.value="";
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  };
</script>

</body>
</html>